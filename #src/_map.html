<script src="https://api-maps.yandex.ru/2.1/?apikey=d02ef18b-3f8a-40d8-ad6a-d6aad95f6099&lang=ru_RU"></script>
<script>
    let locations = [
        {
            "id": 1,
            "districtId": 1,
            "coords": [56.318801, 43.955292],
            "title": 'Нижегородский планетарий им. Г. М. Гречко',
            "address": 'ул. Революционная, д. 20',
            "hours": "Вт–Вс 10:00–20:00",
        },
        {
            "id": 2,
            "districtId": 1,
            "coords": [56.288914, 43.855143],
            "title": 'Центральная районная библиотека им. Ф. М. Достоевского',
            "address": 'ул. Гороховецкая, д. 18А',
            "hours": "Вт–Пт 9:30–19:00; Вс 9:30–17:00"
        },
        {
            "id": 3,
            "districtId": 1,
            "coords": [56.328324, 43.961313],
            "title": 'Название локации',
            "address": 'ул. Совнаркомовская, 13',
            "hours": "Пн–Пт 09:00–18:00"
        },
        {
            "id": 4,
            "districtId": 6,
            "coords": [56.293337, 44.013856],
            "title": 'Название локации',
            "address": 'Советский район, 13',
            "hours": "Пн–Пт 09:00–18:00"
        }
    ]
    let tramRoutes = [
        {
            "id": 1,
            "title": 'Маршрут №5',
            "route": 'Тоннель Московского вокзала',
            "interval": "lpКаждые 10 минут, c 12:17 до 16:09",
            "color": "#8A2A2B",
            "stations": [
                { coords: [56.256205, 43.971813] },
                { coords: [56.261832, 43.973938] },
                { coords: [56.266911, 43.975335] },
                { coords: [56.272044, 43.976540] },
                { coords: [56.274847, 43.982795] },
                { coords: [56.276110, 43.989060] },
                { coords: [56.279405, 43.991067] },
                { coords: [56.282721, 43.993161] },
                { coords: [56.284987, 43.994079] },
                { coords: [56.290178, 43.995526] },
                { coords: [56.294412, 43.994254] },
                { coords: [56.298358, 43.991837] },
                { coords: [56.299902, 43.991509] },
                { coords: [56.303822, 43.989016] },
                { coords: [56.306059, 43.987322] }
            ]
        },
        {
            "id": 2,
            "title": 'Маршрут №6',
            "route": 'Тоннель Московского вокзала',
            "interval": "Каждые 15 минут, c 12:17 до 16:09",
            'width': 9,
            "color": "#EAC637",
            "zIndex": 1,
            "stations": [
                { coords: [56.323759, 43.946128] },
                { coords: [56.328146, 43.938005] },
                { coords: [56.330770, 43.931665] },
                { coords: [56.334154, 43.924126] },
                { coords: [56.335223, 43.916878] },
                { coords: [56.334513, 43.911248] },
                { coords: [56.332506, 43.903666] },
                { coords: [56.330943, 43.899986] },
                { coords: [56.333319, 43.893877] },
                { coords: [56.335960, 43.886991] },
                { coords: [56.337448, 43.884216] },
                { coords: [56.341220, 43.878478] },
                { coords: [56.345019, 43.872536] },
                { coords: [56.349695, 43.865843] },
                { coords: [56.353485, 43.863510] },
                { coords: [56.353135, 43.859203] },
                { coords: [56.352507, 43.851932] },
                { coords: [56.349632, 43.843646] },
                { coords: [56.346808, 43.837840] },
                { coords: [56.343698, 43.836181] },
                { coords: [56.340556, 43.838911] }
            ]
        },
        {
            "id": 3,
            "title": 'Маршрут №6',
            "route": 'Тоннель Московского вокзала',
            "interval": "Каждые 15 минут, c 12:17 до 16:09",
            'width': 9,
            "color": "#EAC637",
            "zIndex": 1,
            "stations": [  
                { coords: [56.343698, 43.836181] },
                { coords: [56.340556, 43.838911] },
                { coords: [56.337913, 43.841383] },
                { coords: [56.335529, 43.846577] },
                { coords: [56.332646, 43.850863] },
                { coords: [56.329791, 43.853356] },
                { coords: [56.331519, 43.860428] },
                { coords: [56.333823, 43.868015] },
                { coords: [56.333442, 43.872136] },
                { coords: [56.336749, 43.876451] },
                { coords: [56.337839, 43.883443] },
                { coords: [56.335865, 43.887074] },
                { coords: [56.333205, 43.893941] },
                { coords: [56.330801, 43.900144] },
                { coords: [56.332147, 43.902899] },
                { coords: [56.334275, 43.910663] },
                { coords: [56.335063, 43.917009] },
                { coords: [56.334036, 43.923792] },
                { coords: [56.330976, 43.931064] },
                { coords: [56.328146, 43.938005] },
                { coords: [56.323940, 43.944684] }
            ]
        },
        {
            "id": 4,
            "title": 'Маршрут №7',
            "route": 'Тоннель Московского вокзала',
            "interval": "Каждые 15 минут, c 12:17 до 16:09",
            "color": "#606484",
            "stations": [
                { coords: [56.323759, 43.946128] },
                { coords: [56.328146, 43.938005] },
                { coords: [56.330770, 43.931665] },
                { coords: [56.334154, 43.924126] },
                { coords: [56.335223, 43.916878] },
                { coords: [56.334513, 43.911248] },
                { coords: [56.332506, 43.903666] },
                { coords: [56.330943, 43.899986] },
                { coords: [56.333319, 43.893877] },
                { coords: [56.335960, 43.886991] },
                { coords: [56.337448, 43.884216] },
                { coords: [56.337121, 43.877139] },
                { coords: [56.334333, 43.873404] },
                { coords: [56.333683, 43.866592] },
                { coords: [56.331651, 43.860571] },
                { coords: [56.330011, 43.853511] },
                { coords: [56.332341, 43.851467] },
                { coords: [56.335649, 43.846142] },
                { coords: [56.337329, 43.842120] },
                { coords: [56.340208, 43.839639] },
                { coords: [56.343365, 43.836853] },
            ]
        },
        {
            "id": 5,
            "title": 'Маршрут №7',
            "route": 'Тоннель Московского вокзала',
            "interval": "Каждые 15 минут, c 12:17 до 16:09",
            "color": "#606484",
            "stations": [
                { coords: [56.340208, 43.839639] },
                { coords: [56.343365, 43.836853] },
                { coords: [56.346772, 43.838010] },
                { coords: [56.348897, 43.843158] },
                { coords: [56.352001, 43.850822] },
                { coords: [56.352882, 43.858534] },
                { coords: [56.353600, 43.862227] },
                { coords: [56.349971, 43.865589] },
                { coords: [56.344993, 43.872379] },
                { coords: [56.341144, 43.878431] },
                { coords: [56.337839, 43.883443] },
                { coords: [56.335865, 43.887074] },
                { coords: [56.333205, 43.893941] },
                { coords: [56.330801, 43.900144] },
                { coords: [56.332147, 43.902899] },
                { coords: [56.334275, 43.910663] },
                { coords: [56.335063, 43.917009] },
                { coords: [56.334036, 43.923792] },
                { coords: [56.330976, 43.931064] },
                { coords: [56.328146, 43.938005] },
                { coords: [56.323940, 43.944684] }
            ]
        },
        {
            "id": 6,
            "title": 'Маршрут №3',
            "route": 'Тоннель Московского вокзала',
            "interval": "Каждые 15 минут, c 12:17 до 16:09",
            "color": "#698460",
            "stations": [
                { coords: [56.265426, 43.921329] },
                { coords: [56.267855, 43.926017] },
                { coords: [56.271067, 43.930759] },
                { coords: [56.273764, 43.933892] },
                { coords: [56.277252, 43.935165] },
                { coords: [56.281141, 43.937939] },
                { coords: [56.285560, 43.940092] },
                { coords: [56.289623, 43.940810] },
                { coords: [56.292036, 43.942044] },
                { coords: [56.296480, 43.942965] },
                { coords: [56.298424, 43.944148] },
                { coords: [56.300807, 43.940684] },
                { coords: [56.302195, 43.938809] },
                { coords: [56.306686, 43.936273] },
                { coords: [56.312518, 43.936137] },
                { coords: [56.317118, 43.941966] },
                { coords: [56.319899, 43.946031] }
            ]
        },
        {
            "id": 7,
            "title": 'Маршрут №8',
            "route": 'Тоннель Московского вокзала',
            "interval": "Каждые 15 минут, c 12:17 до 16:09",
            "color": "#E00101",
            "stations": [
                { coords: [56.281193, 43.897278] },
                { coords: [56.277689, 43.901697] },
                { coords: [56.275748, 43.904146] },
                { coords: [56.271547, 43.909545] },
                { coords: [56.266352, 43.910543] },
                { coords: [56.262223, 43.907805] },
                { coords: [56.257735, 43.902157] },
                { coords: [56.252437, 43.889954] },
                { coords: [56.248541, 43.879927] },
                { coords: [56.244150, 43.869174] },
                { coords: [56.238877, 43.861942] },
                { coords: [56.237043, 43.857329] },
                { coords: [56.234761, 43.851939] },
                { coords: [56.231442, 43.846510] },
                { coords: [56.228617, 43.842075] },
                { coords: [56.225831, 43.837820] },
                { coords: [56.223486, 43.834195] },
                { coords: [56.221913, 43.829969] },
                { coords: [56.218030, 43.826605] },
                { coords: [56.214558, 43.825631] }
            ]
        }
    ];
</script>
<script>
    const switchMapLocBtn = document.querySelector("[data-tab=loc]")
    const switchMapTramBtn = document.querySelector("[data-tab=tram]")
    let center = [56.326797, 44.006516];  
    let locMap
    let tramMap
    let locGeoObjects = [] 
    let tramGeoObjects = []   
    let routePromises = []   
    let maxZoom = 15
    function setmapDefaults(map) {
        map.controls.remove('geolocationControl'); // удаляем геолокацию
        map.controls.remove('searchControl'); // удаляем поиск
        map.controls.remove('trafficControl'); // удаляем контроль трафика
        map.controls.remove('typeSelector'); // удаляем тип
        map.controls.remove('fullscreenControl'); // удаляем кнопку перехода в полноэкранный режим
        map.controls.remove('rulerControl'); // удаляем контрол правил
        map.controls.remove('zoomControl');
        map.margin.setDefaultMargin(100);
    }   
    function locMapInit() {
        locMap = new ymaps.Map('loc-map', {
            center,
            zoom: 6,
        },{
            suppressMapOpenBlock: true,
            suppressObsoleteBrowserNotifier:true,
            yandexMapDisablePoiInteractivity: true, 
        });
        setmapDefaults(locMap)
        if (locations.length)  {
            locations.forEach((item,i) => {
                locGeoObjects[i] = new ymaps.Placemark(item.coords, 
                    {
                        balloonContent: `
                        <div class="balloon loc-baloon">
                            <div class="balloon__header">
                                <p class="accent balloon__name">${item.title}</p>
                            </div>
                            <div class="balloon__body">
                                ${item.address ? `<p>
                                    <span>Адрес:</span>
                                    <span>${item.address}</span>
                                </p>` : ''}
                                 ${item['hours'] ?  `<p>
                                    <span>Режим работы:</span>
                                    <span>${item['hours']}</span>
                                </p>` : ""
                                }
                            </div>
                        </div>`,
                    }, 
                    {
                        balloonPanelMaxMapArea: window.innerWidth < 767.98 ? Infinity : 0,
                        iconLayout: "default#image",
                        iconImageHref: "img/svg/map-marker.svg",
                        iconImageSize: window.innerWidth < 767.98 ? [10, 30] : [21, 61],
                        iconImageOffset: window.innerWidth < 767.98 ? [-5, -30] : [-10.5, -61],
                        cursor: "pointer",
                        hideIconOnBalloonOpen: false,
                        balloonOffset: [90,0]
                    }
                )
            })
            locGeoObjects.forEach(item => locMap.geoObjects.add(item))
            locMap.setBounds(locMap.geoObjects.getBounds(), {checkZoomRange: true, zoomMargin: 100})
            locMap.events.add('click',()=> locMap.balloon.close())
        }
    }  
    function buildRoute(points, thisRoute, callback) {
        if (!tramMap) {
            console.error('Карта не инициализирована');
            if (callback) callback();
            return;
        }
        let route = new ymaps.multiRouter.MultiRoute(
            {
                referencePoints: points.map(point => point.coords),
                params: {
                    routingMode: 'masstransit', 
                    results: 1, 
                    routingTypes: { 
                        tram: true, 
                        auto: false,
                        bus: false,
                        trolleybus: false, 
                        subway: false,
                        pedestrian: false 
                    }
                }
            }, 
            {
                zIndex: thisRoute.zIndex ?  thisRoute.zIndex : 100, 
                wayPointVisible: false,
                viaPointVisible: false,
                pinVisible: false,
                routeActivePedestrianIconVisible: false,
                routeActiveMarkerVisible: false,

                routeActiveStrokeWidth: thisRoute.width || 5,
                routeActiveStrokeStyle: 'solid',
                routeActiveStrokeColor: thisRoute.color || '#1e98ff',

                routeActiveWalkSegmentStrokeWidth: thisRoute.width || 5,
                routeActiveWalkSegmentStrokeStyle: 'solid',
                routeActiveWalkSegmentStrokeColor: thisRoute.color || '#1e98ff',
                routeActiveStrokeColor2: '#000000',
            }
        );
        tramMap.geoObjects.add(route);
        route.model.events.add('requestsuccess', function() {
            if (callback) callback();
        });
        
        route.model.events.add('requesterror', function() {
            if (callback) callback(); 
        });
        route.events.add('click', function(event) {
            event.preventDefault();
            const coords = event.get('coords');
            const balloonContent = `
                <div class="balloon">
                    <div class="balloon__header">
                        <p class="accent balloon__name">${thisRoute.title}</p>
                    </div>
                    <div class="balloon__body">
                        ${thisRoute['route'] ? `<p>
                            <span>Кольцевой маршрут: </span>
                            <span>${thisRoute['route']}</span>
                        </p>` : ''}
                         ${thisRoute['interval'] ?  `<p>
                            <span>Интервал: </span>
                            <span>${thisRoute['interval']}</span>
                        </p>` : ""
                        }
                    </div>
                </div>
            `;           
            tramMap.balloon.open(coords, balloonContent,{
                panelMaxMapArea: window.innerWidth < 767.98 ? Infinity : 0,
                offset: [75,50]
            }); 
        }); 
    }        
    function tramMapInit() {
        tramMap = new ymaps.Map('tram-map', {
            center,
            zoom: 6
        },{
            suppressMapOpenBlock: true,
            suppressObsoleteBrowserNotifier:true,
            yandexMapDisablePoiInteractivity: true,
        });
        setmapDefaults(tramMap)  
        tramRoutes.forEach(route => {
            if (route.stations.length) {
                route.stations.forEach(el => tramGeoObjects.push(el.coords))
                routePromises.push(
                    new Promise(resolve => {
                        buildRoute(route.stations, route, resolve);
                    })
                );
            }
        })
        Promise.all(routePromises).then(() => {
            tramMap.setBounds(ymaps.util.bounds.fromPoints(tramGeoObjects), {
                checkZoomRange: true, 
                zoomMargin: 100
            });
        });
        tramMap.events.add('click',() => tramMap.balloon.close())    
    }
    if (document.querySelector("#loc-map") && document.querySelector("#tram-map")) {
        ymaps.ready(() => {
            locMapInit()
            tramMapInit()
        });
        let mapTimeout
        window.addEventListener("resize", () => {
            clearTimeout(mapTimeout)
            if (locMap) {
                locMap.destroy()
            }
            if (tramMap) {
                tramMap.destroy()
            }
            mapTimeout = setTimeout(() => {
                locMapInit()
                tramMapInit()
            }, 300);
        })
    }
</script>